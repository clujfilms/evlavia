<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin - Biserica Evlavia</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body,html {
      background: linear-gradient(135deg, #1e1e2f, #2d2d44);
      color: #f5f5f5;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      padding: 2rem;
    }
    header {
      background: rgba(30,30,47,0.85);
      backdrop-filter: blur(8px);
      color: #00c7b7;
      text-align: center;
      padding: 1rem;
      margin-bottom: 2rem;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    nav {
      margin-top: 0.5rem;
    }
    nav a {
      margin: 0.25rem;
      background: #00c7b7;
      color: #1e1e2f;
      padding: 0.45rem 1rem;
      border-radius: 8px;
      text-decoration: none;
      font-weight: bold;
      transition: 0.3s;
    }
    nav a:hover {
      background: #00a397;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: rgba(255,255,255,0.05);
      padding: 2rem;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.25);
      margin-bottom: 2rem;
      backdrop-filter: blur(12px);
    }

    h2 {
      text-align: center;
      margin-bottom: 1rem;
      color: #ffffff;
    }

    input, textarea, button {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: none;
      border-radius: 10px;
      font-size: 1rem;
    }

    input, textarea {
      background: #2a2a40;
      color: #fff;
      border: 1px solid #444;
    }

    input::placeholder, textarea::placeholder {
      color: #aaa;
    }

    button {
      background: #00c7b7;
      color: #1e1e2f;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      background: #00a397;
    }

    .tab-btn {
      background: #3b3b5f;
      color: #fff;
      border: none;
      padding: 0.6rem 1rem;
      margin: 0.25rem;
      border-radius: 6px;
      font-weight: 600;
      transition: 0.3s;
    }

    .tab-btn.active {
      background: #00c7b7;
      color: #1e1e2f;
    }

    .item {
      background: #2a2a40;
      padding: 0.6rem;
      border-radius: 8px;
      margin-bottom: 0.5rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #eee;
    }

    .item button {
      width: auto;
      padding: 0.4rem 0.8rem;
      background: #d32f2f;
      color: white;
      border: none;
      border-radius: 6px;
    }

    .item button:hover {
      background: #b71c1c;
    }
  </style>
</head>
<body>

<header>
  <h1>Panou Administrativ</h1>
  <nav>
    <a href="index.html">Acasă</a>
    <a href="despre.html">Despre</a>
    <a href="program.html">Program</a>
    <a href="resurse.html">Resurse</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<!-- Login -->
<div class="container" id="loginContainer">
  <h2>Autentificare</h2>
  <input type="email" id="email" placeholder="Email">
  <input type="password" id="password" placeholder="Parolă">
  <button onclick="login()">Login</button>
</div>

<!-- Tabs -->
<div class="container" id="adminPanel" style="display:none">
  <div style="text-align:center;margin-bottom:1rem">
    <button class="tab-btn active" id="tabAnunt" onclick="switchTab('anunt')">Anunțuri</button>
    <button class="tab-btn" id="tabPredica" onclick="switchTab('predica')">Predici</button>
  </div>

  <!-- Anunțuri -->
  <section id="anuntSection">
    <h2>Adaugă anunț</h2>
    <input type="text" id="annTitle" placeholder="Titlu anunț">
    <textarea id="annDesc" rows="4" placeholder="Descriere"></textarea>
    <input type="file" id="annImg" accept="image/*">
    <button onclick="postAnnouncement()">Publică anunț</button>
    <div id="annList"></div>
  </section>

  <!-- Predici -->
  <section id="predicaSection" style="display:none">
    <h2>Adaugă predică</h2>
    <input type="text" id="sermTitle" placeholder="Titlu predică">
    <input type="url" id="sermUrl" placeholder="Link YouTube">
    <button onclick="postSermon()">Publică predică</button>
    <div id="sermList"></div>
  </section>
</div>

<div class="container" id="logoutContainer" style="display:none">
  <button onclick="logout()">Logout</button>
</div>

<!-- Firebase + Logic -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCHHreJKNeTe7rdeHgN9wfCQFOvQJYMOEE",
    authDomain:"evlavia.firebaseapp.com",
    projectId:"evlavia",
    storageBucket:"evlavia.appspot.com",
    messagingSenderId:"45584336554",
    appId:"1:45584336554:web:eb59effd5cbc38405c32d3"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const st   = getStorage(app);

  const $ = id => document.getElementById(id);
  const embed = url => url.includes("embed") ? url : url.replace("watch?v=","embed/").replace("youtu.be/","www.youtube.com/embed/");

  async function login() {
    try {
      await signInWithEmailAndPassword(auth, $("email").value, $("password").value);
    } catch (e) {
      alert(e.message);
    }
  }

  function logout() {
    signOut(auth);
    location.reload();
  }

  async function postAnnouncement() {
    const title = $("annTitle").value.trim();
    const desc  = $("annDesc").value.trim();
    const file  = $("annImg").files[0];
    if (!title || !desc || !file) { alert("Completați toate câmpurile!"); return; }
    const refImg = ref(st, `anunturi/${Date.now()}_${file.name}`);
    await uploadBytes(refImg, file);
    const url = await getDownloadURL(refImg);
    await addDoc(collection(db, "anunturi"), { title, description: desc, imageUrl: url, timestamp: serverTimestamp() });
    $("annTitle").value = ""; $("annDesc").value = ""; $("annImg").value = "";
    loadAnnouncements();
  }

  async function loadAnnouncements() {
    const list = $("annList"); list.innerHTML = "";
    const snap = await getDocs(query(collection(db, "anunturi"), orderBy("timestamp", "desc")));
    snap.forEach(d => {
      const it = document.createElement("div"); it.className = "item";
      it.innerHTML = `<span>${d.data().title}</span><button onclick="delDoc('anunturi','${d.id}',loadAnnouncements)">Șterge</button>`;
      list.appendChild(it);
    });
  }

  async function postSermon() {
    const title = $("sermTitle").value.trim();
    const urlRaw = $("sermUrl").value.trim();
    if (!title || !urlRaw) { alert("Completați toate câmpurile!"); return; }
    await addDoc(collection(db, "predici"), { title, videoUrl: embed(urlRaw), timestamp: serverTimestamp() });
    $("sermTitle").value = ""; $("sermUrl").value = "";
    loadSermons();
  }

  async function loadSermons() {
    const list = $("sermList"); list.innerHTML = "";
    const snap = await getDocs(query(collection(db, "predici"), orderBy("timestamp", "desc")));
    snap.forEach(d => {
      const it = document.createElement("div"); it.className = "item";
      it.innerHTML = `<span>${d.data().title}</span><button onclick="delDoc('predici','${d.id}',loadSermons)">Șterge</button>`;
      list.appendChild(it);
    });
  }

  window.delDoc = async (col,id,cb)=>{await deleteDoc(doc(db,col,id));cb();};

  window.switchTab = tab => {
    $("tabAnunt").classList.remove("active");
    $("tabPredica").classList.remove("active");
    $("anuntSection").style.display = "none";
    $("predicaSection").style.display = "none";
    if(tab==="anunt"){ $("tabAnunt").classList.add("active"); $("anuntSection").style.display = "block"; }
    else{ $("tabPredica").classList.add("active"); $("predicaSection").style.display = "block"; }
  };

  let idleTimer;
  function resetIdleTimer() {
    clearTimeout(idleTimer);
    idleTimer = setTimeout(() => {
      signOut(auth);
      alert("Ai fost delogat după 5 minute de inactivitate.");
      location.reload();
    }, 5 * 60 * 1000);
  }
  ["click","mousemove","keydown","scroll","touchstart"].forEach(e => {
    document.addEventListener(e, resetIdleTimer);
  });

  window.addEventListener("beforeunload", () => signOut(auth));

  onAuthStateChanged(auth, user => {
    if(user){
      $("loginContainer").style.display = "none";
      $("adminPanel").style.display = "block";
      $("logoutContainer").style.display = "block";
      loadAnnouncements();
      loadSermons();
      resetIdleTimer();
    }
  });

  window.login = login;
  window.logout = logout;
  window.postAnnouncement = postAnnouncement;
  window.postSermon = postSermon;
</script>
</body>
</html>
